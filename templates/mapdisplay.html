<html>

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title>Google Maps - gmplot</title>

    <style>
        .sideDisplay {
            height: 100%; /* Full-height: remove this if you want "auto" height */
            width: 350px; /* Set the width of the sidebar */
            position: fixed; /* Fixed Sidebar (stay in place on scroll) */
            z-index: 1; /* Stay on top */
            top: 0; /* Stay at the top */
            right: 0;
            background-color: white;
            padding-top: 20px;
            overflow-y: auto;
            font-family: 'lato', sans-serif;
            border-left-style: solid;
            border-left-width: 2px;
            border-left-color: lightgrey;
        }
        .sideDisplay a {
            padding: 6px 8px 6px 16px;
            text-decoration: none;
            font-size: 25px;
            color: darkslategray;
            display: block;
            box-shadow: none;
        }
        .sideDisplay table{ 
            padding: 6px 8px 6px 16px;
            font-family: 'lato', Arial, Helvetica, sans-serif;
            border-radius: 3px;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            box-shadow: none;
        }

        .tableHeader {
            background-color: lightgray;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            box-shadow: none;
        }

        .tableRow {
            background-color: #ffffff;
            box-shadow: none;
            font-size:12px;
        }

        .main {
            margin-right: 350px; /* Same as the width of the sidebar */
            /* padding: 0px 10px; */
            overflow-y: hidden;
            font-style: italic;
        }
    </style>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier/1.0.3/oms.min.js"></script>
    <script type="text/javascript"
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAO-r75d8IVw3xwou82zXbABZnrNUFSKGY&libraries=geometry&callback=initMap"></script>
    <script type="text/javascript">

        

        var map;
        function parseIPJson() {
            var ipStrings = $(tracert_json).val();
            console.log(ipStrings);
            var json = JSON.parse(ipStrings);
            const allips = {};
            for (let traceroute in json) {
                let iplist = {};
                for (let hop in json[traceroute].result) {
                    var hopinfo = json[traceroute].result[hop];
                    if (hopinfo.result[0].from === undefined) { continue; }
                    let latency = 0;
                    for (let packet in hopinfo.result) {
                        latency = ((latency * parseFloat(packet)) + parseFloat(hopinfo.result[packet].rtt)) / (parseFloat(packet) + 1);
                    }
                    iplist[hopinfo.result[0].from] = latency.toString();
                }
                allips[traceroute] = iplist;
            }
            console.log('all ips:' + JSON.stringify(allips));
            doSearch(JSON.stringify(allips));
        }
        function download(name, type) {
            var a = document.getElementById("a");
            var text = $(tracert_raw).val();
            var file = new Blob([convertToJSON(text)], { type: type });
            a.href = URL.createObjectURL(file);
            a.download = name;
            a.click();
        }

        function convertToJSON(text) {
            const hopArray = text.split(/\r?\n/);
            let parsedHopArray = [];
            for (let hop in hopArray) {
                let line = hopArray[hop];
                if (line === '') {
                    continue
                }
                const elements = line.split("  ");
                if (elements[0] === '') {
                    elements.splice(0, 1);
                }
                parsedHopArray.push(elements);
            }
            var TracertJsonString = JSON.stringify(parsedHopArray);
            return TracertJsonString;

        }

        function logFile(event) {
            // let str = event.target.result;
            let json = JSON.parse(event.target.result);
            console.log(json);
            const allips = {};
            for (let traceroute in json) {
                let iplist = {};
                for (let hop in json[traceroute].result) {
                    var hopinfo = json[traceroute].result[hop];
                    if (hopinfo.result[0].from === undefined) { continue; }
                    let latency = 0;
                    for (let packet in hopinfo.result) {
                        latency = ((latency * parseFloat(packet)) + parseFloat(hopinfo.result[packet].rtt)) / (parseFloat(packet) + 1);
                    }
                    iplist[hopinfo.result[0].from] = latency.toString();
                }
                allips[traceroute] = iplist;
            }
            console.log('all ips:' + JSON.stringify(allips));
            doSearch(JSON.stringify(allips));
        }

        function getTracerts() {
            event.preventDefault();
            let file = document.querySelector('#file');
            let form = document.querySelector('#upload');
            if (!file.value.length) return;
            let reader = new FileReader();
            reader.onload = logFile;
            reader.readAsText(file.files[0]);
        }


        function parseIPRaw() {
            var ipStrings = $(tracert_raw).val();
            const ipArray = ipStrings.split(/\r?\n/);
            let ips = ''
            for (let index in ipArray) {
                let line = ipArray[index];
                if (line.substring(0, 4) == '    ') {
                    continue
                }
                let ip = '';
                let position1 = line.search("\\(");
                let position2 = line.search("\\)");
                let currentPosition = position1 + 1;
                while (currentPosition < position2) {
                    ip = ip + line[currentPosition];
                    currentPosition = currentPosition + 1;
                }
                if (position1 != -1) {
                    ips = ips + ip + ',';
                }
            }
            ips = ips.substring(0, ips.length - 1);
            doSearch(ips);
        }


        function doSearch(ipArray) {

            $.ajax({
                url: "/getip",
                type: "POST",
                data: {
                    ipaddress: ipArray,
                },
                success: function (data) {


                    alert(data);
                    data = JSON.parse(data);

                    var nodeIds = {}; // format: {nodeId1: {ip1: {info}, ip2: {info}}, nodeId2: {ip3: {info}}}

                    for (let index in data) {

                        let tracertInfo = data[index];

                        for (let ipaddress in tracertInfo) {

                            let ipinfo = tracertInfo[ipaddress];

                            let nodeID = (ipinfo['nodeid']).toString();
                            if (nodeIds[nodeID] === undefined) {
                                nodeIds[nodeID] = [];
                            }
                            let ipadrinfo = nodeIds[nodeID];
                            ipadrinfo.push(ipinfo);
                            nodeIds[nodeID] = ipadrinfo;
                        }
                    }

                    console.log(nodeIds);

                    const asColorMap = new Map();

                    for (let node in nodeIds) {



                        loc = { 'lat': parseFloat((nodeIds[node][0]['coordinates']).split(',')[0]), 'lng': parseFloat((nodeIds[node][0]['coordinates']).split(',')[1]) };


                        let contentString = '<h2>Node ID: ' + node.toString() + '</h2>Coordinates: ' + nodeIds[node][0]['coordinates']

                        let locInfo = null;

                        for (let x in nodeIds[node]) {
                            locInfo = nodeIds[node][x];
                            const currentContentString = '<br><br><b>Interface ' + (parseFloat(x) + 1).toString() + '</b><br>IP Address: ' + locInfo['ip'] + '<br>Traceroute #' + locInfo['tracertnum'] + '<br>AS Number: ' + locInfo['asnum'] + '<br>Method: ' + locInfo['method'];
                            contentString = contentString + currentContentString;

                        }


                        if (!asColorMap.has(locInfo['asnum'])) {
                            asColorMap.set(locInfo['asnum'], (0x1000000 + Math.random() * 0xffffff).toString(16).substr(1, 6))
                        }

                        const colorHex = asColorMap.get(locInfo['asnum']).toString(16);

                        const infowindow = new google.maps.InfoWindow({
                            content: contentString,
                        });

                        const marker = new google.maps.Marker({
                            position: loc,
                            map: map,
                            // label: contentString,
                            // icon: 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=|' + 
                            // // label: String(index + 1),
                            icon: 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=|' + colorHex + '|000000',

                        });
                        marker.addListener("click", () => {
                            infowindow.open({
                                anchor: marker,
                                map,
                            })
                        })
                    }



                    var locationPaths = {};

                    for (let index in data) {

                        locationPath = {};

                        for (let ip in data[index]) {
                            info = { "coordinates": data[index][ip]["coordinates"], "latency": data[index][ip]["latency"] }
                            locationPath[ip.toString()] = info;

                        }

                        locationPaths[index.toString()] = locationPath;
                    }

                    console.log(locationPaths);

                    const TracerouteColorMap = new Map();


                    for (let n in locationPaths) {

                        TracerouteColorMap.set(n, '#' + (0x1000000 + Math.random() * 0xffffff).toString(16).substr(1, 6))


                        const colorHex = TracerouteColorMap.get(n);

                        for (let x in locationPaths[n]) {



                            let coords = { 'lat': parseFloat((locationPaths[n][x]['coordinates']).split(',')[0]), 'lng': parseFloat((locationPaths[n][x]['coordinates']).split(',')[1]) };


                            if (parseFloat(x) + 1 === Object.keys(locationPaths[n]).length) {
                                console.log('final coords');
                            }

                            else {

                                nextLocInfo = locationPaths[n][(parseFloat(x) + 1).toString()];

                                let nextcoords = { 'lat': parseFloat((nextLocInfo['coordinates']).split(',')[0]), 'lng': parseFloat((nextLocInfo['coordinates']).split(',')[1]) };

                                let locs = [coords, nextcoords]
                                // console.log(locs);

                                locationPaths[n][x].polyline = new google.maps.Polyline({
                                    path: locs,
                                    geodesic: true,
                                    strokeColor: colorHex,
                                    strokeOpacity: 1.0,
                                    strokeWeight: 2,
                                    map: map,
                                });

                                google.maps.event.addListener(locationPaths[n][x].polyline, 'click', (mapsMouseEvent) => {


                                    locationPaths[n][x].infoWindow = new google.maps.InfoWindow({
                                        position: mapsMouseEvent.latLng,
                                        content: 'Average Latency: ' + (locationPaths[n][(parseFloat(x) + 1).toString()]['latency']).toString(),
                                    });

                                    locationPaths[n][x].infoWindow.open(map);

                                });
                            }
                        }
                    }

                    var dataTable = document.getElementById('InfoTable');

                    for (let index in data) {

                        var row = dataTable.insertRow(-1);
                        row.className = 'tableRow';
                        var cell = row.insertCell(0);
                        cell.colSpan = 2;
                        var coloredcell = row.insertCell(-1);
                        cell.innerHTML = '<b> Traceroute ' + (parseFloat(index)+1).toString();
                        coloredcell.style.backgroundColor = TracerouteColorMap.get(index);
                        coloredcell.colSpan = 6
                     
                        for (let ip in data[index]) {

                            var row = dataTable.insertRow(-1);
                            row.className = 'tableRow';
                            var ipadrcell = row.insertCell(0);
                            var nodeidcell = row.insertCell(1);
                            var latcell = row.insertCell(2);
                            var longcell = row.insertCell(3);
                            var asnumcell = row.insertCell(4);
                            var asnumcolorcell = row.insertCell(5);
                            var hostnamecell = row.insertCell(6);
                            var methodcell = row.insertCell(7);
                            ipadrcell.innerHTML = data[index][ip]['ip'];
                            nodeidcell.innerHTML = data[index][ip]['nodeid'];
                            latcell.innerHTML = data[index][ip]['coordinates'].split(',')[0];
                            longcell.innerHTML = data[index][ip]['coordinates'].split(',')[1];
                            asnumcell.innerHTML = data[index][ip]['asnum'];
                            asnumcolorcell.style.backgroundColor = asColorMap.get(data[index][ip]['asnum']);
                            asnumcolorcell.style.width = '10px';
                            hostnamecell.innerHTML = data[index][ip]['hostname'];
                            methodcell.innerHTML = data[index][ip]['method'];

                        }
                    }


                    // alert(data);
                    // data = JSON.parse(data);

                    // var locations =  new Array();
                    // var nodes = new Array();

                    // for (let ip in data) {
                    //     var location = new Object();
                    //     var loc = (data[ip]['coordinates']).split(',');
                    //     location['lat'] = parseFloat(loc[0]);
                    //     location['lng'] = parseFloat(loc[1]);
                    //     locations[ip] = location;

                    //     // nodes.push(data[ip]['nodeid']);
                    // }

                    // console.log(locations);

                    // const flightPath = new google.maps.Polyline({
                    //     path: Object.values(locations),
                    //     geodesic: true,
                    //     strokeColor: "#FF0000",
                    //     strokeOpacity: 1.0,
                    //     strokeWeight: 2,
                    // });


                    // var nodeIDs = new Array();
                    // var nodeData = new Array();

                    // for (let ipadr in data) {

                    //     if ((Object.values(nodeIDs)).includes(data[ipadr]['nodeid'])==true){
                    //         currentContentStr = nodeData[Object.keys(nodeData)[Object.values(nodeIDs).indexOf(data[ipadr]['nodeid'])]];
                    //         nodeData[Object.keys(nodeData)[Object.values(nodeIDs).indexOf(data[ipadr]['nodeid'])]] = currentContentStr + "<br><br>"+ data[ipadr]['ip'] + "<br>AS Number: " + data[ipadr]['asnum'] + "<br>Method: " + data[ipadr]['method'] + "<br>Hostname: " + data[ipadr]['hostname'];

                    //     }
                    //     else{
                    //         const contentstring = data[ipadr]['ip'] + "<br>AS Number: " + data[ipadr]['asnum'] + "<br>Method: " + data[ipadr]['method'] + "<br>Hostname: " + data[ipadr]['hostname'];
                    //         nodeData[ipadr] = contentstring;
                    //         nodeIDs[ipadr] = data[ipadr]['nodeid'];
                    //     }
                    // }
                    // console.log(nodeData);

                    // const oms = new OverlappingMarkerSpiderfier(map, {
                    //         markersWontMove: true,
                    //         markersWontHide: true,
                    //         basicFormatEvents: true
                    //     });
                    // var index = 0
                    // const asColorMap = new Map();

                    // for (let ipadr in nodeData) {
                    //     // if (nodeIDsUsed.includes(data[ipadr]['nodeid'])==true){

                    //     // }
                    //     // nodeIDsUsed.push(data[ipadr]['nodeid']);
                    //     // const contentstring = data[ipadr]['ip'] + "<br>AS Number: " + data[ipadr]['asnum'] + "<br>Method: " + data[ipadr]['method'] + "<br>Hostname: " + data[ipadr]['hostname']
                    //     if (!asColorMap.has(data[ipadr]['asnum'])){
                    //         asColorMap.set(data[ipadr]['asnum'], Math.floor(Math.random() * (0xFFFFFF + 1)))
                    //     }
                    //     const infowindow = new google.maps.InfoWindow({
                    //         content: nodeData[ipadr]
                    //     });
                    //     const colorHex = asColorMap.get(data[ipadr]['asnum']).toString(16);

                    //     const marker = new google.maps.Marker({
                    //         position: locations[ipadr],
                    //         map: map,
                    //         label: String(index + 1),
                    //         icon: 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=|'+colorHex+'|000000',
                    //     });
                    //     marker.addListener("spider_click",()=> {
                    //         infowindow.open({
                    //             anchor: marker,
                    //             map,
                    //         })
                    //     });
                    //     oms.addMarker(marker);

                    //     var index = index + 1
                    // }

                    // flightPath.setMap(map);
                }
            });
        }
        const BOUNDS = {
            north: 65.283569,
            south: 65.283569,
            west: -169.325060,
            east: -169.325060,
        };

        function initialize() {

            map = new google.maps.Map(document.getElementById("map_canvas"), {
                restriction: {
                latLngBounds: BOUNDS,
                strictBounds: false,
                },
                zoom: 3,
                center: new google.maps.LatLng(35.994033, -78.898619)
            });


        }
    </script>
    
    <!-- <link rel="stylesheet" type="text/css" href="style.css" /> -->

</head>

<body style="margin:0px; padding:0px;" onload="initialize()">

    <div class="sideDisplay" >
        <table id = "InfoTable">
            <tr class = "tableHeader">

                <td>IP Address</td>
                <td>Node ID</td>
                <td>Latitude</td>
                <td>Longitude</td>
                <td colspan = 2>AS Number</td>
                <td>Hostname</td>
                <td>Method</td>
                
            </tr>
        </table>
        <!-- <a id = "sideInfo"></a> -->
    </div>

    <div class="main">
        <div style="margin:20px">
            <table>
                <tr>
                    <td><text>JSON Format:</text><br>
                        <textarea id="tracert_json" name="tracert_json" rows="4"
                            cols="50">{"fw":5020,"mver":"2.2.1","lts":67,"endtime":1641013316,"dst_name":"2001:503:c27::2:30","dst_addr":"2001:503:c27::2:30","src_addr":"2001:19f0:7001:22c8:5400:ff:fe59:8d4f","proto":"UDP","af":6,"size":40,"paris_id":4,"result":[{"hop":1,"result":[{"x":"*"},{"x":"*"},{"x":"*"}]},{"hop":2,"result":[{"from":"2001:19f0:7000:c640::1","ttl":63,"rtt":0.581,"size":88},{"from":"2001:19f0:7000:c640::1","ttl":63,"rtt":0.315,"size":88},{"from":"2001:19f0:7000:c640::1","ttl":63,"rtt":0.835,"size":88}]},{"hop":3,"result":[{"from":"2001:19f0:fc00::a47:111","ttl":62,"rtt":1.369,"size":88},{"from":"2001:19f0:fc00::a47:111","ttl":62,"rtt":1.05,"size":88},{"from":"2001:19f0:fc00::a47:111","ttl":62,"rtt":16.589,"size":88}]},{"hop":4,"result":[{"x":"*"},{"x":"*"},{"x":"*"}]},{"hop":5,"result":[{"x":"*"},{"x":"*"},{"x":"*"}]},{"hop":6,"result":[{"from":"2001:470:0:622::1","ttl":60,"rtt":0.61,"size":88},{"from":"2001:470:0:622::1","ttl":60,"rtt":0.732,"size":88},{"from":"2001:470:0:622::1","ttl":60,"rtt":0.418,"size":88}]},{"hop":7,"result":[{"from":"2001:470:0:3f0::1","ttl":59,"rtt":78.0,"size":88},{"from":"2001:470:0:3f0::1","ttl":59,"rtt":88.83,"size":88},{"from":"2001:470:0:3f0::1","ttl":59,"rtt":86.187,"size":88}]},{"hop":8,"result":[{"from":"2001:470:1:35c::2","ttl":54,"rtt":85.734,"size":88},{"from":"2001:470:1:35c::2","ttl":54,"rtt":71.106,"size":88},{"from":"2001:470:1:35c::2","ttl":54,"rtt":71.716,"size":88}]},{"hop":9,"result":[{"from":"2001:d98:e:4::24","ttl":55,"rtt":67.868,"size":88},{"from":"2001:d98:e:4::24","ttl":55,"rtt":67.937,"size":88},{"from":"2001:d98:e:4::24","ttl":55,"rtt":67.94,"size":88}]},{"hop":10,"result":[{"x":"*"},{"x":"*"},{"x":"*"}]},{"hop":11,"result":[{"x":"*"},{"x":"*"},{"x":"*"}]},{"hop":12,"result":[{"x":"*"},{"x":"*"},{"x":"*"}]},{"hop":13,"result":[{"x":"*"},{"x":"*"},{"x":"*"}]},{"hop":14,"result":[{"x":"*"},{"x":"*"},{"x":"*"}]},{"hop":255,"result":[{"x":"*"},{"x":"*"},{"x":"*"}]}],"msm_id":6016,"prb_id":1001877,"timestamp":1641013207,"msm_name":"Traceroute","from":"2001:19f0:7001:22c8:5400:ff:fe59:8d4f","type":"traceroute","stored_timestamp":1641013446}</textarea>
                        <br><button id="searchip_json" onclick="parseIPJson()" value="json">Display IP route</button>
                    </td>
                    <td><text>Raw Traceroute Format:</text><br>
                        <textarea id="tracert_raw" name="tracert_raw" rows="4" cols="50"> 1  176.587.89.163 (176.58.89.163)  4.344 ms  3.350 ms  4.516 ms

        2  176.58.90.161 (176.58.90.161)  3.066 ms  73.962 ms  3.082 ms

        3  104.225.12.95 (104.225.12.95)  3.865 ms  2.880 ms  5.561 ms

        4  208.111.34.237 (208.111.34.237)  5.500 ms  5.042 ms  5.534 ms</textarea>
                        <br><button id="searchip_raw" onclick="parseIPRaw()" value="raw">Display IP route</button>
                        <a hidden href="" id="a">click here to download your file</a>
                        <button onclick="download('myfilename.txt', 'text/plain')">Save JSON file</button>
                </tr>
            </table>
            </td>

            <form id="upload">
                <label for="file">File to upload</label>
                <input type="file" id="file" accept=".json">

                <button onclick="getTracerts()">Upload</button>
            </form>

        </div>
        <div id="map_canvas" style="width: 100%; height: 100%;"></div>
    </div>
</body>

</html>